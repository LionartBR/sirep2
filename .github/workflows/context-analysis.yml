name: AnÃ¡lise AvanÃ§ada de Contexto

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  analise-contexto-avancada:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo completo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Cache de dependÃªncias
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-analysis-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-analysis-

      - name: ðŸ”§ Instalar dependÃªncias de anÃ¡lise (sem conflito)
        run: |
          python -m pip install --upgrade pip
          
          # Instalar ferramentas de anÃ¡lise PRIMEIRO (sem requirements.txt)
          pip install radon==6.0.1
          pip install pylint==3.3.8
          pip install black==25.9.0
          pip install isort==6.0.1
          pip install bandit==1.8.6
          pip install mypy==1.18.2
          
          echo "âœ… Ferramentas de anÃ¡lise instaladas"

      - name: ðŸ“¦ Instalar dependÃªncias do projeto (opcional)
        run: |
          # Tentar instalar requirements.txt, mas nÃ£o falhar se houver erro
          if [ -f requirements.txt ]; then
            echo "Tentando instalar requirements.txt..."
            pip install -r requirements.txt --no-deps || echo "âš ï¸ Alguns pacotes falharam (nÃ£o crÃ­tico)"
          fi
          
          # Alternativas
          if [ -f setup.py ]; then
            pip install -e . --no-deps || echo "âš ï¸ Setup.py falhou"
          fi
          
          if [ -f pyproject.toml ]; then
            pip install . --no-deps || echo "âš ï¸ pyproject.toml falhou"
          fi
        continue-on-error: true

      - name: ðŸ” Executar anÃ¡lise avanÃ§ada de contexto
        id: analise
        run: |
          echo "ðŸ” Iniciando anÃ¡lise..."
          python .github/scripts/context_analyzer.py \
            --output report.md \
            --json analysis_data.json
          
          echo "analysis_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ“Š Gerar badge de saÃºde
        if: always() && steps.analise.outputs.analysis_completed == 'true'
        run: |
          if [ -f report.md ]; then
            SCORE=$(grep -oP 'Score de SaÃºde: \K\d+' report.md || echo "0")
            echo "HEALTH_SCORE=$SCORE" >> $GITHUB_ENV
            
            if [ "$SCORE" -ge 80 ]; then
              echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
              echo "BADGE_STATUS=Excelente" >> $GITHUB_ENV
            elif [ "$SCORE" -ge 60 ]; then
              echo "BADGE_COLOR=yellow" >> $GITHUB_ENV
              echo "BADGE_STATUS=Bom" >> $GITHUB_ENV
            else
              echo "BADGE_COLOR=red" >> $GITHUB_ENV
              echo "BADGE_STATUS=CrÃ­tico" >> $GITHUB_ENV
            fi
          fi

      - name: ðŸ’¬ Comentar no PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let report = '## ðŸ”¬ AnÃ¡lise AvanÃ§ada de Contexto\n\n';
            
            if (fs.existsSync('report.md')) {
              const fullReport = fs.readFileSync('report.md', 'utf8');
              
              // Limitar tamanho do comentÃ¡rio (GitHub tem limite)
              if (fullReport.length > 60000) {
                report += fullReport.substring(0, 60000);
                report += '\n\n... (relatÃ³rio truncado - veja artifacts para versÃ£o completa)';
              } else {
                report += fullReport;
              }
            } else {
              report += 'âŒ Erro ao gerar relatÃ³rio.\n\n';
              report += 'PossÃ­veis causas:\n';
              report += '- Script context_analyzer.py nÃ£o encontrado\n';
              report += '- Erro de sintaxe no cÃ³digo Python\n';
              report += '- Falta de permissÃµes\n';
            }
            
            report += '\n\n---\n';
            report += `ðŸ“Ž [Ver anÃ¡lise completa nos Artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            // Buscar comentÃ¡rio anterior
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('AnÃ¡lise AvanÃ§ada de Contexto')
            );
            
            // Atualizar ou criar
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: ðŸ“ˆ AnÃ¡lises complementares
        if: always()
        run: |
          echo "ðŸ” Executando anÃ¡lises complementares..."
          
          # Radon - Complexidade
          echo "## ðŸ“Š Complexidade CiclomÃ¡tica" > complexity.txt
          echo "" >> complexity.txt
          radon cc . -a -s --total-average >> complexity.txt 2>&1 || echo "Sem anÃ¡lise disponÃ­vel" >> complexity.txt
          
          # Radon - Maintainability Index  
          echo "" >> complexity.txt
          echo "## ðŸ”§ Ãndice de Manutenibilidade" >> complexity.txt
          echo "" >> complexity.txt
          radon mi . -s >> complexity.txt 2>&1 || echo "Sem anÃ¡lise disponÃ­vel" >> complexity.txt
          
          # Bandit - SeguranÃ§a
          echo "## ðŸ”’ AnÃ¡lise de SeguranÃ§a" > security.txt
          echo "" >> security.txt
          bandit -r . -f txt >> security.txt 2>&1 || echo "Nenhum problema de seguranÃ§a detectado" >> security.txt
          
          # Black - FormataÃ§Ã£o
          echo "## âœ¨ VerificaÃ§Ã£o de FormataÃ§Ã£o" > formatting.txt
          echo "" >> formatting.txt
          black --check --diff . >> formatting.txt 2>&1 || echo "Alguns arquivos precisam formataÃ§Ã£o" >> formatting.txt
          
          echo "âœ… AnÃ¡lises complementares concluÃ­das"

      - name: ðŸ“¦ Upload relatÃ³rios como artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-completo-${{ github.run_number }}
          path: |
            report.md
            analysis_data.json
            complexity.txt
            security.txt
            formatting.txt
          retention-days: 30

      - name: ðŸš¨ Verificar problemas crÃ­ticos
        if: always()
        run: |
          EXIT_CODE=0
          
          if [ -f report.md ]; then
            # Contar problemas crÃ­ticos
            CRITICAL=$(grep -c "ðŸš¨" report.md 2>/dev/null || echo "0")
            
            echo "::notice::Problemas crÃ­ticos encontrados: $CRITICAL"
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "::error::$CRITICAL problema(s) crÃ­tico(s) detectado(s)!"
              echo "::error::Corrija os problemas antes de fazer merge."
              EXIT_CODE=1
            else
              echo "::notice::âœ… Nenhum problema crÃ­tico detectado"
            fi
          else
            echo "::warning::RelatÃ³rio nÃ£o gerado - verifique os logs"
          fi
          
          exit $EXIT_CODE

      - name: ðŸ“Š Gerar GitHub Summary
        if: always()
        run: |
          echo "# ðŸ”¬ AnÃ¡lise de Contexto - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f analysis_data.json ]; then
            # Extrair dados do JSON
            TOTAL_FUNCS=$(jq -r '.stats.total_functions // 0' analysis_data.json)
            TOTAL_CLASSES=$(jq -r '.stats.total_classes // 0' analysis_data.json)
            TOTAL_ISSUES=$(jq -r '.stats.total_issues // 0' analysis_data.json)
            
            echo "## ðŸ“Š EstatÃ­sticas" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------:|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”§ FunÃ§Ãµes | $TOTAL_FUNCS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Classes | $TOTAL_CLASSES |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Problemas | $TOTAL_ISSUES |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Score de saÃºde
            if [ -f report.md ]; then
              SCORE=$(grep -oP 'Score de SaÃºde: \K\d+' report.md || echo "N/A")
              echo "## ðŸŽ¯ Score de SaÃºde" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### $SCORE / 100" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Top 5 problemas
            echo "## ðŸŽ¯ Top 5 Problemas" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '.issues[:5] // [] | .[] | "- **[\(.severity | ascii_upcase)]** \(.message)"' analysis_data.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Nenhum problema detectado" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ AnÃ¡lise nÃ£o concluÃ­da" >> $GITHUB_STEP_SUMMARY
          fi

  analise-diff:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”„ Analisar arquivos modificados
        run: |
          echo "# ðŸ“ Arquivos Modificados Neste PR" > diff_analysis.md
          echo "" >> diff_analysis.md
          
          # Obter arquivos Python modificados
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' || true)
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "## Arquivos Python Alterados" >> diff_analysis.md
            echo "" >> diff_analysis.md
            
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
                ADDED=$(git diff origin/${{ github.base_ref }}...HEAD -- "$file" | grep -c "^+" || echo "0")
                REMOVED=$(git diff origin/${{ github.base_ref }}...HEAD -- "$file" | grep -c "^-" || echo "0")
                
                echo "### \`$file\`" >> diff_analysis.md
                echo "- **Linhas totais:** $LINES" >> diff_analysis.md
                echo "- **Linhas adicionadas:** $ADDED" >> diff_analysis.md
                echo "- **Linhas removidas:** $REMOVED" >> diff_analysis.md
                echo "" >> diff_analysis.md
              fi
            done <<< "$CHANGED_FILES"
            
            # EstatÃ­sticas gerais
            NUM_FILES=$(echo "$CHANGED_FILES" | wc -l)
            echo "---" >> diff_analysis.md
            echo "" >> diff_analysis.md
            echo "**Total:** $NUM_FILES arquivo(s) Python modificado(s)" >> diff_analysis.md
          else
            echo "âœ… Nenhum arquivo Python modificado neste PR." >> diff_analysis.md
          fi

      - name: ðŸ“¤ Upload anÃ¡lise de diff
        uses: actions/upload-artifact@v4
        with:
          name: diff-analysis
          path: diff_analysis.md
          retention-days: 30