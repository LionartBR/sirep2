name: AnÃ¡lise AvanÃ§ada de Contexto

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  analise-contexto-avancada:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo completo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # HistÃ³rico completo para anÃ¡lise de evoluÃ§Ã£o

      - name: ðŸ Setup Python otimizado
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Instalar dependÃªncias de anÃ¡lise
        run: |
          python -m pip install --upgrade pip
          pip install radon pylint black isort bandit safety mypy
          
          # Instalar dependÃªncias do projeto (se existir)
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f setup.py ]; then
            pip install -e .
          elif [ -f pyproject.toml ]; then
            pip install .
          fi

      - name: ðŸ” Executar anÃ¡lise avanÃ§ada de contexto
        id: analise
        run: |
          python .github/scripts/context_analyzer.py \
            --output report.md \
            --json analysis_data.json
        continue-on-error: true

      - name: ðŸ“Š Gerar badge de saÃºde
        if: always()
        run: |
          # Extrair score do relatÃ³rio
          if [ -f report.md ]; then
            SCORE=$(grep -oP 'Score de SaÃºde: \K\d+' report.md || echo "0")
            echo "HEALTH_SCORE=$SCORE" >> $GITHUB_ENV
            
            if [ "$SCORE" -ge 80 ]; then
              echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
            elif [ "$SCORE" -ge 60 ]; then
              echo "BADGE_COLOR=yellow" >> $GITHUB_ENV
            else
              echo "BADGE_COLOR=red" >> $GITHUB_ENV
            fi
          fi

      - name: ðŸ’¬ Comentar no PR com anÃ¡lise completa
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Ler relatÃ³rio
            let report = '## ðŸ”¬ AnÃ¡lise AvanÃ§ada de Contexto\n\n';
            
            if (fs.existsSync('report.md')) {
              report += fs.readFileSync('report.md', 'utf8');
            } else {
              report += 'âŒ Erro ao gerar relatÃ³rio de anÃ¡lise.';
            }
            
            // Adicionar link para artifacts
            report += '\n\n---\n';
            report += `ðŸ“Ž [Ver anÃ¡lise completa nos Artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            
            // Buscar comentÃ¡rio anterior
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('AnÃ¡lise AvanÃ§ada de Contexto')
            );
            
            // Atualizar ou criar comentÃ¡rio
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: ðŸ“ˆ AnÃ¡lises complementares
        if: always()
        run: |
          echo "ðŸ” Executando anÃ¡lises complementares..."
          
          # Radon - Complexidade ciclomÃ¡tica
          echo "## Complexidade por arquivo:" > complexity.txt
          radon cc . -a -s || echo "Sem anÃ¡lise de complexidade"
          
          # Radon - Maintainability Index
          echo "## Ãndice de Manutenibilidade:" >> complexity.txt
          radon mi . -s || echo "Sem anÃ¡lise de manutenibilidade"
          
          # Bandit - SeguranÃ§a
          echo "## AnÃ¡lise de SeguranÃ§a:" > security.txt
          bandit -r . -f txt -o security.txt || echo "Sem problemas de seguranÃ§a"
          
          # MyPy - Type hints (se houver)
          if find . -name "*.py" -exec grep -l "from typing import\|: str\|: int\|: bool" {} \; | head -1; then
            echo "## Type Checking:" > types.txt
            mypy . --ignore-missing-imports --no-error-summary || echo "Type hints OK"
          fi

      - name: ðŸ“¦ Upload relatÃ³rios como artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-completo-${{ github.sha }}
          path: |
            report.md
            analysis_data.json
            complexity.txt
            security.txt
            types.txt
          retention-days: 30

      - name: ðŸš¨ Verificar problemas crÃ­ticos
        if: always()
        run: |
          if [ -f report.md ]; then
            # Contar problemas crÃ­ticos
            CRITICAL=$(grep -c "ðŸš¨" report.md || echo "0")
            
            echo "Problemas crÃ­ticos encontrados: $CRITICAL"
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "::error::$CRITICAL problema(s) crÃ­tico(s) detectado(s)! Verifique o relatÃ³rio."
              exit 1
            fi
          fi

      - name: ðŸ“Š Gerar summary
        if: always()
        run: |
          if [ -f analysis_data.json ]; then
            echo "## ðŸ“Š Resumo da AnÃ¡lise" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extrair dados do JSON
            TOTAL_FUNCS=$(jq -r '.stats.total_functions' analysis_data.json)
            TOTAL_CLASSES=$(jq -r '.stats.total_classes' analysis_data.json)
            TOTAL_ISSUES=$(jq -r '.stats.total_issues' analysis_data.json)
            
            echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| FunÃ§Ãµes | $TOTAL_FUNCS |" >> $GITHUB_STEP_SUMMARY
            echo "| Classes | $TOTAL_CLASSES |" >> $GITHUB_STEP_SUMMARY
            echo "| Problemas | $TOTAL_ISSUES |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Top 5 problemas
            echo "### ðŸŽ¯ Top 5 Problemas" >> $GITHUB_STEP_SUMMARY
            jq -r '.issues[:5] | .[] | "- **[\(.severity)]** \(.message)"' analysis_data.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ’¾ Salvar mÃ©tricas histÃ³ricas (opcional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p .metrics
          cp analysis_data.json .metrics/analysis_$(date +%Y%m%d_%H%M%S).json
          
          # Manter apenas Ãºltimas 10 anÃ¡lises
          ls -t .metrics/analysis_*.json | tail -n +11 | xargs -r rm
          
          # Commit se houver mudanÃ§as (requer configuraÃ§Ã£o adicional)
          # git config --local user.email "action@github.com"
          # git config --local user.name "GitHub Action"
          # git add .metrics/
          # git commit -m "chore: atualizar mÃ©tricas de anÃ¡lise" || echo "Sem mudanÃ§as"
          # git push

  analise-diff:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”„ Analisar apenas arquivos modificados
        run: |
          echo "## ðŸ“ Arquivos Modificados" > diff_analysis.md
          
          # Obter lista de arquivos Python modificados
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' > changed_files.txt || true
          
          if [ -s changed_files.txt ]; then
            echo "" >> diff_analysis.md
            echo "Arquivos Python modificados neste PR:" >> diff_analysis.md
            cat changed_files.txt | while read file; do
              if [ -f "$file" ]; then
                LINES=$(wc -l < "$file")
                echo "- \`$file\` ($LINES linhas)" >> diff_analysis.md
              fi
            done
          else
            echo "Nenhum arquivo Python modificado." >> diff_analysis.md
          fi

      - name: ðŸ“¤ Upload anÃ¡lise de diff
        uses: actions/upload-artifact@v4
        with:
          name: diff-analysis
          path: diff_analysis.md